<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Operating Systems: Process API | TeaPort</title><meta name="author" content="Cheng,tctco2018@gmail.com"><meta name="copyright" content="Cheng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Interlude: Process API The fork System Call 123456789101112131415161718192021#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;unistd.h&gt;int main(int argc, char *argvp[]) &amp;#123;  printf(">
<meta property="og:type" content="article">
<meta property="og:title" content="Operating Systems: Process API">
<meta property="og:url" content="http://tctco.github.io/2020/08/18/Operating-Systems-Process-API/index.html">
<meta property="og:site_name" content="TeaPort">
<meta property="og:description" content="Interlude: Process API The fork System Call 123456789101112131415161718192021#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;unistd.h&gt;int main(int argc, char *argvp[]) &amp;#123;  printf(">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://tctco.github.io/images/mountain.png">
<meta property="article:published_time" content="2020-08-17T18:02:10.000Z">
<meta property="article:modified_time" content="2023-02-02T18:02:43.550Z">
<meta property="article:author" content="Cheng">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tctco.github.io/images/mountain.png"><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="http://tctco.github.io/2020/08/18/Operating-Systems-Process-API/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Operating Systems: Process API',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-03 02:02:43'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3878240_8myeori5grd.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3878240_ab970ja65pp.css"><link rel="stylesheet" href="/static/css/bilibili.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">83</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/static/operations/"><i class="fa-fw iconfont icon-shoushudao1"></i><span> 技能考试</span></a></li><li><a class="site-page child" href="/static/model/"><i class="fa-fw iconfont icon-jiandanmoxing"></i><span> 小鼠模型</span></a></li><li><a class="site-page child" href="/static/timetable"><i class="fa-fw iconfont icon--timetable"></i><span> 课表</span></a></li><li><a class="site-page child" href="/static/workingcard"><i class="fa-fw iconfont icon-bangdingyuangongka"></i><span> 员工卡</span></a></li><li><a class="site-page child" href="/static/radar"><i class="fa-fw iconfont icon-radarchart"></i><span> 雷达图</span></a></li><li><a class="site-page child" href="/static/audiogram"><i class="fa-fw iconfont icon-hearing"></i><span> 电测听</span></a></li><li><a class="site-page child" href="/static/medreconstruct"><i class="fa-fw iconfont icon-115"></i><span> 图像重建</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/static/cv"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/mountain.png')"><nav id="nav"><span id="blog-info"><a href="/" title="TeaPort"><span class="site-name">TeaPort</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/static/operations/"><i class="fa-fw iconfont icon-shoushudao1"></i><span> 技能考试</span></a></li><li><a class="site-page child" href="/static/model/"><i class="fa-fw iconfont icon-jiandanmoxing"></i><span> 小鼠模型</span></a></li><li><a class="site-page child" href="/static/timetable"><i class="fa-fw iconfont icon--timetable"></i><span> 课表</span></a></li><li><a class="site-page child" href="/static/workingcard"><i class="fa-fw iconfont icon-bangdingyuangongka"></i><span> 员工卡</span></a></li><li><a class="site-page child" href="/static/radar"><i class="fa-fw iconfont icon-radarchart"></i><span> 雷达图</span></a></li><li><a class="site-page child" href="/static/audiogram"><i class="fa-fw iconfont icon-hearing"></i><span> 电测听</span></a></li><li><a class="site-page child" href="/static/medreconstruct"><i class="fa-fw iconfont icon-115"></i><span> 图像重建</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/static/cv"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Operating Systems: Process API</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-08-17T18:02:10.000Z" title="发表于 2020-08-18 02:02:10">2020-08-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-02T18:02:43.550Z" title="更新于 2023-02-03 02:02:43">2023-02-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/OS/">OS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Operating Systems: Process API"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>Interlude: Process API</h1>
<h2 id="The-fork-System-Call">The <code>fork</code> System Call</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argvp[])</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello world (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">  <span class="type">int</span> rc = fork();</span><br><span class="line">  <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// fork failed</span></span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// child (new process)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, I am child (pid:%d)&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// parent goes down this path (main)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, I am parent of %d (pid:%d)\n&quot;</span>, </span><br><span class="line">           rc, (<span class="type">int</span>) getpid());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The interesting part begins. The process calls the <code>fork()</code> system call, which the OS provides as a way to create a new process. The odd part: the process that is created is an (almost) exact copy of the calling process. That means that to the OS, it now looks like there are two copies of the program running, and both are about to return from the <code>fork()</code> system call. The newly-created process (called the <strong>child</strong>, in contrast to the creating <strong>parent</strong>) doesn’t start running at <code>main()</code>; rather, it just comes into life as if it had called <code>fork()</code> itself.</p>
<p>The child isn’t an exact copy. Specifically, although it now has its own copy of the address space (i.e., its own private memory), its own registers, its own PC, and so forth, the value it returns to the caller of <code>fork()</code> is different. . Specifically, while the parent receives the PID of the newly-created child, the child receives a return code of zero.</p>
<p>The output is not <strong>deterministic</strong>. Assuming we are running on a system with a single CPU (for simplicity), then either the child or the parent might run at that point. The parent or the child can print message first.</p>
<blockquote>
<p>However, in my experiment, the parent always print first.</p>
</blockquote>
<p>The CPU <strong>scheduler</strong> determines which process runs at a given moment in time; because the scheduler is complex, we cannot usually make strong assumptions about what it will choose to do, and hence which process will run first. This <strong>non-determinism</strong> , as it turns out, leads to some interesting problems, particularly in <strong>multi-threaded programs</strong>; hence, we’ll see a lot more non-determinism when we study <strong>concurrency</strong>.</p>
<h2 id="The-wait-System-Call">The <code>wait()</code> System Call</h2>
<p>Sometimes, as it turns out, it is quite useful for a parent to wait for a child process to finish what it has been doing. This task is accomplished with the <code>wait()</code> system call (or its more complete sibling <code>waitpid()</code>).</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello world (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">  <span class="type">int</span> rc = fork();</span><br><span class="line">  <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123; </span><br><span class="line">    <span class="comment">// fork failed; exit</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123; </span><br><span class="line">    <span class="comment">// child (new process)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, I am child (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="comment">// parent goes down this path (main)</span></span><br><span class="line">    <span class="type">int</span> rc_wait = wait(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, I am parent of %d (rc_wait:%d) (pid:%d)\n&quot;</span>,</span><br><span class="line">            rc, rc_wait, (<span class="type">int</span>) getpid());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The child might simply run first and print before the parent. However, if the parent does happen to run first, it will immediately call <code>wait()</code>; this system call won’t return until the child has run and exited.</p>
<h2 id="The-exec-System-Call">The <code>exec()</code> System Call</h2>
<p>The <code>exec()</code> is useful when you want to run a program that is different from the calling program.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello world (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">  <span class="type">int</span> rc = fork();</span><br><span class="line">  <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// fork failed</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello, I am child (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">    <span class="type">char</span>* myargs[<span class="number">3</span>];</span><br><span class="line">    myargs[<span class="number">0</span>] = strdup(<span class="string">&quot;wc&quot;</span>); <span class="comment">// copy string to the given address</span></span><br><span class="line">    													<span class="comment">// program &quot;wc&quot; (word count)</span></span><br><span class="line">    myargs[<span class="number">1</span>] = strdup(<span class="string">&quot;p3.c&quot;</span>); <span class="comment">// argument: file to count</span></span><br><span class="line">    myargs[<span class="number">2</span>] = <span class="literal">NULL</span>; <span class="comment">// marks end of array</span></span><br><span class="line">    execvp(myargs[<span class="number">0</span>], myargs); <span class="comment">// run word count</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this shouldn&#x27;t print out&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">int</span> rc_wait = wait(<span class="literal">NULL</span>);</span><br><span class="line">    print(<span class="string">&quot;hello, I am the parent of %d (rc_wait:%d) (pid:%d)\n&quot;</span></span><br><span class="line">          rc, rc_wait, (<span class="type">int</span>) getpid());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>fork()</code> system call is strange; its partner in crime, <code>exec()</code>, is not so normal either. What it does: given the name of an executable (e.g., <code>wc</code>), and some arguments (e.g., <code>p3.c</code>), it <strong>loads</strong> code (and static data) from that executable and overwrites its current code segment (and current static data with it); the heap and stack and other parts of the memory space of the program are re-initialized. Then the OS simply runs that program, passing in any arguments, as the <code>argv</code> of that process. Thus, it does not create a new process; rather, it transforms the currently running program into a different running program (<code>wc</code>). After the <code>exec()</code> in the child, it is almost as if <code>p3.c</code> never ran; a successful call to <code>exec()</code> never returns.</p>
<h2 id="Why-Motivating-The-API">Why? Motivating The API</h2>
<p>The separation of<code>fork()</code> and <code>exec()</code> is essential in building a UNIX shell, because it lets the shell run code after the call to <code>fork()</code> but before the call to <code>exec()</code>; this code can alter the environment of the about-to-be-run program, and thus enables a variety of interesting features to be readily built.</p>
<p>The shell is just a user program. It shows you a <strong>prompt</strong> and then waits for you to type something into it. You then a command (i.e., the name of an executable program, plus any arguments) into it; in most cases, the shell then figures out where in the file system the executable resides, calls <code>fork()</code> to create a new child process to run the command, calls some variant of <code>exec()</code> to run the command, and then waits for the command to complete by calling <code>wait()</code>. When the child completes, the shell returns from <code>wait()</code> and prints out a prompt again, ready for your next command.</p>
<p>The separation of <code>fork()</code>  and <code>exec()</code> allows the shell to do a whole bunch of useful things rather easily. For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wc</span> p3.c &gt; newfile.txt</span><br></pre></td></tr></table></figure>
<p>The output of <code>wc</code> is <strong>redirected</strong> into the output file <code>newfile.txt</code> .  The way the shell accomplishes this task is quite simple: when the child is created, before calling <code>exec()</code>, the shell closes <strong>standard output</strong> and opens the file <code>newfile.txt</code>. By doing so, any output from the soon-to-be-running program <code>wc</code> are sent to the file instead of the screen.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sdtio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  <span class="type">int</span> rc = fork();</span><br><span class="line">  <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// fork failed</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// child: redirect standard output to a file</span></span><br><span class="line">    close(STDOUT_FILENO);</span><br><span class="line">    open(<span class="string">&quot;./p4.output&quot;</span>, O_CREAT|O_WRONGLY|O_TRUNC, S_IRWXU);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// now exec &quot;wc&quot;</span></span><br><span class="line">    <span class="type">char</span> *myargs[<span class="number">3</span>];</span><br><span class="line">    myargs[<span class="number">0</span>] = strdup(<span class="string">&quot;wc&quot;</span>);</span><br><span class="line">    myargs[<span class="number">1</span>] = strdup(<span class="string">&quot;p4.c&quot;</span>);</span><br><span class="line">    myargs[<span class="number">2</span>] = <span class="literal">NULL</span>;</span><br><span class="line">    execvp(myargs[<span class="number">0</span>], myargs);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// parent goes down this path (main)</span></span><br><span class="line">    <span class="type">int</span> rc_wait = wait(<span class="literal">NULL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Process-Control-and-Users">Process Control and Users</h2>
<p>There are a lot of other interfaces for interacting with processes in UNIX systems. For example, the <code>kill()</code> system call is used to send <strong>signals</strong> to a process, including directives to pause, die, and other useful imperatives.</p>
<p>The entire signals subsystem provides a rich infrastructure to deliver external events to processes, including ways to receive and process those signals within individual processes, and ways to send signals to individual processes as well as entire <strong>process groups</strong>. To use this form of communication, a process should use the <code>signal()</code> system call to “catch” various signals; doing so ensures that when a particular signal is delivered to a process, it will suspend its normal execution and run a particular piece of code in response to the signal.</p>
<h2 id="Homework">Homework</h2>
<h3 id="Simulation">Simulation</h3>
<ol>
<li>
<p>One interesting thing to note is what happens when a child exits; what happens to its children in the process tree? To study this, let’s create a specific example: <code>./fork.py -A a+b,b+c,c+d,c+e,c-</code>. This example has process ’a’ create ’b’, which in turn creates ’c’, which then creates ’d’ and ’e’. However, then, ’c’ exits. What do you think the process tree should like after the exit? What if you use the <code>-R</code> flag? Learn more about what happens to orphaned processes on your own to add more context.</p>
<ul>
<li>The process will be concatenated to the <code>a</code> init process. When <code>-R</code> flag is given, the process is re-attached to its ancestor <code>b</code>.</li>
</ul>
</li>
<li>
<p>Use both <code>-t</code> and <code>-F</code> together. This shows the final process tree, but then asks you to fill in the actions that took place. By looking at the tree, can you determine the exact actions that took place? In which cases can you tell? In which can’t you tell? Try some different random seeds to delve into this question.</p>
</li>
</ol>
<h3 id="Code">Code</h3>
<ol>
<li>
<p>Write a program that calls <code>fork()</code>. Before calling <code>fork()</code>, have the main process access a variable (e.g., <code>x</code>) and set its value to something (e.g., 100). What value is the variable in the child process? What happens to the variable when both the child and parent change the value of <code>x</code>?</p>
<ul>
<li>The value in the child is the same as the one in the main process. It seems that the child and the main process both have a copy of the original variable. They changed their own variable separately.</li>
</ul>
</li>
<li>
<p>Write a program that opens a file (with the<code>open()</code> system call) and then calls<code> fork()</code> to create a new process. Can both the child and parent access the file descriptor returned by <code>open()</code>? What happens when they are writing to the file concurrently, i.e., at the same time?</p>
<ul>
<li>Yes, both processes can access the file descriptor returned by <code>open()</code> and write to the file at the same time.</li>
</ul>
</li>
<li>
<p>Write another program using <code>fork()</code>. The child process should print “hello”; the parent process should print “goodbye”. You should try to ensure that the child process always prints first; can you do this without calling <code>wait()</code> in the parent?</p>
<ul>
<li>Use <code>sleep(1)</code> in the <code>&lt;unistd.h&gt;</code> library at the main process.</li>
</ul>
</li>
<li>
<p>Write a program that calls fork() and then calls some form of <code>exec()</code> to run the program <code>/bin/ls</code>. See if you can try all of the variants of <code>exec()</code>, including (on Linux) <code>execl()</code>, <code>execle()</code>, <code>execlp()</code>, <code>execv()</code>, <code>execvp()</code>, and <code>execvpe()</code>. Why do you think there are so many variants of the same basic call?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">execl</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">const</span> <span class="type">char</span>* args, ...)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execlp</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* file, <span class="type">const</span> <span class="type">char</span>* args, ...)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execle</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">const</span> <span class="type">char</span> *args, ..., <span class="type">char</span>* <span class="type">const</span> envp[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execv</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* path, <span class="type">char</span>* <span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvp</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* file, <span class="type">char</span>* <span class="type">const</span> argv[])</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Now write a program that uses <code>wait()</code> to wait for the child process to finish in the parent. What does <code>wait()</code> return? What happens if you use <code>wait()</code> in the child?</p>
<ul>
<li>The <code>wait()</code> will return the child <code>pid</code>. The <code>wait()</code> will return -1 in the child process.</li>
</ul>
</li>
<li>
<p>Write a slight modification of the previous program, this time using <code>waitpid()</code> instead of <code>wait()</code>. When would <code>waitpid()</code> be useful?</p>
<ul>
<li>When there are multiple children processes <code>waitpid</code> could be useful to wait for the specific child’s state change.</li>
</ul>
</li>
<li>
<p>Write a program that creates a child process, and then in the child closes standard output (<code>STDOUT FILENO</code>). What happens if the child calls <code>printf()</code> to print some output after closing the descriptor?</p>
<ul>
<li>The child can no longer print anything on the screen while the parent can still print. However, if the <code>stdout</code> is closed in the parent process, the child is not able to print anything either.</li>
</ul>
</li>
<li>
<p>Write a program that creates two children, and connects the standard output of one to the standard input of the other, using the <code>pipe()</code> system call.</p>
<ul>
<li>The core code can be viewed with <code>man pipe</code> command.</li>
</ul>
</li>
</ol>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/images/mountain.png" data-sites="wechat,weibo,qq,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/08/Mechanism-Limited-Direct-Execution/" title="Mechanism: Limited Direct Execution"><img class="cover" src="/images/ink.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Mechanism: Limited Direct Execution</div></div></a></div><div class="next-post pull-right"><a href="/2020/08/18/Operating-Systems-The-Process/" title="Operating Systems: The Process"><img class="cover" src="/images/CMYK.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Operating Systems: The Process</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Cheng</div><div class="author-info__description">Tech nerd, Amateur programmar, Medical Student</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">83</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/tctco"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=859267560&amp;website=www.oicqzone.com" target="_blank" title=""><i class="fab fa-qq"></i></a><a class="social-icon" href="https://github.com/tctco" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:tctco2018@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Interlude: Process API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-fork-System-Call"><span class="toc-number">1.1.</span> <span class="toc-text">The fork System Call</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-wait-System-Call"><span class="toc-number">1.2.</span> <span class="toc-text">The wait() System Call</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-exec-System-Call"><span class="toc-number">1.3.</span> <span class="toc-text">The exec() System Call</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-Motivating-The-API"><span class="toc-number">1.4.</span> <span class="toc-text">Why? Motivating The API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Process-Control-and-Users"><span class="toc-number">1.5.</span> <span class="toc-text">Process Control and Users</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Homework"><span class="toc-number">1.6.</span> <span class="toc-text">Homework</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Simulation"><span class="toc-number">1.6.1.</span> <span class="toc-text">Simulation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code"><span class="toc-number">1.6.2.</span> <span class="toc-text">Code</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/01/19/SuStaIn%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="SuStaIn学习笔记"><img src="/images/dopamine.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SuStaIn学习笔记"/></a><div class="content"><a class="title" href="/2024/01/19/SuStaIn%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="SuStaIn学习笔记">SuStaIn学习笔记</a><time datetime="2024-01-19T11:58:53.000Z" title="发表于 2024-01-19 19:58:53">2024-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/27/%E7%94%9F%E4%BF%A1%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/" title="生信生存指南"><img src="/images/ink.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="生信生存指南"/></a><div class="content"><a class="title" href="/2023/12/27/%E7%94%9F%E4%BF%A1%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/" title="生信生存指南">生信生存指南</a><time datetime="2023-12-27T12:57:23.000Z" title="发表于 2023-12-27 20:57:23">2023-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/23/%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F/" title="访问者模式"><img src="/images/CMYK.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="访问者模式"/></a><div class="content"><a class="title" href="/2023/12/23/%E8%AE%BF%E9%97%AE%E8%80%85%E6%A8%A1%E5%BC%8F/" title="访问者模式">访问者模式</a><time datetime="2023-12-23T11:48:36.000Z" title="发表于 2023-12-23 19:48:36">2023-12-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/22/%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F/" title="模板模式"><img src="/images/dopamine.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="模板模式"/></a><div class="content"><a class="title" href="/2023/12/22/%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F/" title="模板模式">模板模式</a><time datetime="2023-12-22T14:13:13.000Z" title="发表于 2023-12-22 22:13:13">2023-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/20/%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%BC%8F/" title="状态机模式"><img src="/images/ChristmasTrees.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="状态机模式"/></a><div class="content"><a class="title" href="/2023/12/20/%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%BC%8F/" title="状态机模式">状态机模式</a><time datetime="2023-12-20T09:20:18.000Z" title="发表于 2023-12-20 17:20:18">2023-12-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Cheng</div><div class="footer_custom_text">很高兴遇见你。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>