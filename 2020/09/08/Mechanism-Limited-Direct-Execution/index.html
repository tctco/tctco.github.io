<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Mechanism: Limited Direct Execution | TC的小站</title><meta name="author" content="Cheng,tctco2018@gmail.com"><meta name="copyright" content="Cheng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Mechanism: Limited Direct Execution A few challenges:  Performance Control  Basic Technique: Limited Direct Execution  OS:  Create entry for process list. Allocate memory for program. Load program int">
<meta property="og:type" content="article">
<meta property="og:title" content="Mechanism: Limited Direct Execution">
<meta property="og:url" content="http://tctco.github.io/2020/09/08/Mechanism-Limited-Direct-Execution/index.html">
<meta property="og:site_name" content="TC的小站">
<meta property="og:description" content="Mechanism: Limited Direct Execution A few challenges:  Performance Control  Basic Technique: Limited Direct Execution  OS:  Create entry for process list. Allocate memory for program. Load program int">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://tctco.github.io/images/tardis.png">
<meta property="article:published_time" content="2020-09-07T18:04:19.000Z">
<meta property="article:modified_time" content="2023-02-02T18:05:12.135Z">
<meta property="article:author" content="Cheng">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tctco.github.io/images/tardis.png"><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="http://tctco.github.io/2020/09/08/Mechanism-Limited-Direct-Execution/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Mechanism: Limited Direct Execution',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-03 02:05:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3878240_8myeori5grd.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3878240_ab970ja65pp.css"><link rel="stylesheet" href="/static/css/bilibili.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/static/operations/"><i class="fa-fw iconfont icon-shoushudao1"></i><span> 技能考试</span></a></li><li><a class="site-page child" href="/static/model/"><i class="fa-fw iconfont icon-jiandanmoxing"></i><span> 小鼠模型</span></a></li><li><a class="site-page child" href="/static/timetable"><i class="fa-fw iconfont icon--timetable"></i><span> 课表</span></a></li><li><a class="site-page child" href="/static/workingcard"><i class="fa-fw iconfont icon-bangdingyuangongka"></i><span> 员工卡</span></a></li><li><a class="site-page child" href="/static/radar"><i class="fa-fw iconfont icon-radarchart"></i><span> 雷达图</span></a></li><li><a class="site-page child" href="/static/audiogram"><i class="fa-fw iconfont icon-hearing"></i><span> 电测听</span></a></li><li><a class="site-page child" href="/static/medreconstruct"><i class="fa-fw iconfont icon-115"></i><span> 图像重建</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/static/cv"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/tardis.png')"><nav id="nav"><span id="blog-info"><a href="/" title="TC的小站"><span class="site-name">TC的小站</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/static/operations/"><i class="fa-fw iconfont icon-shoushudao1"></i><span> 技能考试</span></a></li><li><a class="site-page child" href="/static/model/"><i class="fa-fw iconfont icon-jiandanmoxing"></i><span> 小鼠模型</span></a></li><li><a class="site-page child" href="/static/timetable"><i class="fa-fw iconfont icon--timetable"></i><span> 课表</span></a></li><li><a class="site-page child" href="/static/workingcard"><i class="fa-fw iconfont icon-bangdingyuangongka"></i><span> 员工卡</span></a></li><li><a class="site-page child" href="/static/radar"><i class="fa-fw iconfont icon-radarchart"></i><span> 雷达图</span></a></li><li><a class="site-page child" href="/static/audiogram"><i class="fa-fw iconfont icon-hearing"></i><span> 电测听</span></a></li><li><a class="site-page child" href="/static/medreconstruct"><i class="fa-fw iconfont icon-115"></i><span> 图像重建</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/static/cv"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Mechanism: Limited Direct Execution</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-07T18:04:19.000Z" title="发表于 2020-09-08 02:04:19">2020-09-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-02T18:05:12.135Z" title="更新于 2023-02-03 02:05:12">2023-02-03</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Mechanism: Limited Direct Execution"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>Mechanism: Limited Direct Execution</h1>
<p>A few challenges:</p>
<ul>
<li>Performance</li>
<li>Control</li>
</ul>
<h2 id="Basic-Technique-Limited-Direct-Execution">Basic Technique: Limited Direct Execution</h2>
<ol>
<li><strong>OS</strong>:
<ol>
<li>Create entry for process list.</li>
<li>Allocate memory for program.</li>
<li>Load program into memory.</li>
<li>Set up stack with argc/argv.</li>
<li>Clear registers. Execute <strong>call</strong> <code>main()</code>.</li>
</ol>
</li>
<li><strong>Program</strong>:
<ol>
<li>Run <code>main()</code>.</li>
<li>Execute <strong>return</strong> from main.</li>
</ol>
</li>
<li><strong>OS</strong>:
<ol>
<li>Free memory of process.</li>
<li>Remove from process list.</li>
</ol>
</li>
</ol>
<h2 id="Problem-1-Restricted-Operations">Problem #1: Restricted Operations</h2>
<p>What if the process wishes to perform some kind of restricted operation, such as issuing an I/O request to a disk, or gaining access to more system resources such as CPU or memory?</p>
<p>The approach we take is to introduce a new processor mode, known as the <strong>user mode</strong>; code that runs in user mode is restricted in what it can do. For example, when running  in user mode, a process can’t issue I/O requests; doing so would result in the processor raising an exception; the OS would then likely kill the process.</p>
<p>In contrast to user mode is <strong>kernel mode</strong>, which the operating system (or kernel) runs in. In this mode, code that runs can do what it likes, including privileged operations such as issuing I/O requests and executing all types of restricted instructions.</p>
<p>To enable a user process to perform some kind of privileged operation, virtually all modern hardware provides the ability for user programs to perform a <strong>system call</strong>.</p>
<blockquote>
<p>USE PROTECTED CONTROL TRANSFER:</p>
<p>The hardware assists the OS by providing different modes of execution. In user mode, applications do not have full access to hardware resources. In kernel mode, the OS has access to the full resources of the machine. Special instructions to <strong>trap</strong> into the kernel and <strong>return-from-trap</strong> back to user-mode programs are also provided, as well as instructions that allow the OS to tell the hardware where the <strong>trap table</strong> resides in memory.</p>
<p>中断(interrupt)也称陷阱(Trap)。Trap Table 也就是中断向量表。</p>
</blockquote>
<p>To execute a system call, a program must executer a special <strong>trap</strong> instruction. This instruction simultaneously jumps into the kernel and raises the privilege level to kernel mode. Once in the kernel, the system can now perform whatever privileged operations are needed (if allowed), and thus do the required work for the calling process. When finished, the OS calls a special <strong>return-from-trap</strong> instruction, which returns into the calling user program while simultaneously reducing the privilege level back to user mode.</p>
<p>The hardware needs to be a bit careful when executing a trap, in that it must make sure to save enough of the caller’s registers in order to be able to return correctly when the OS issues the return-from-trap instruction. An x86 the processor will push the program counter, flags, and a few other registers onto a per-process <strong>kernel stack</strong>; the return-from-trap will pop these values off the stack and resume execution of the user mode program.</p>
<ol>
<li><strong>OS at boot (kernel mode)</strong> : Initialize trap table</li>
<li><strong>Hardware</strong>: remember address of syscall handler</li>
<li><strong>OS at run (kernel mode)</strong>:
<ol>
<li>Create entry for process list</li>
<li>Allocate memory for program</li>
<li>Load program into memory</li>
<li>Setup user stack with argv</li>
<li>Fill kernel stack with reg/PC</li>
<li><strong>return-from-trap</strong></li>
</ol>
</li>
<li><strong>Hardware</strong>:
<ol>
<li>Restore regs (from kernel stack)</li>
<li>Remove to user mode</li>
<li>Jump to main</li>
</ol>
</li>
<li><strong>Program (user mode)</strong>:
<ol>
<li>Run <code>main()</code></li>
<li>…</li>
<li>Call system call</li>
<li><strong>Trap</strong> into OS</li>
</ol>
</li>
<li><strong>Hardware</strong>:
<ol>
<li>save regs (to kernel stack)</li>
<li>move to kernel mode</li>
<li>jump to trap handler</li>
</ol>
</li>
<li><strong>OS</strong>:
<ol>
<li>Handle trap (Do work of syscall)</li>
<li><strong>return-from-trap</strong></li>
</ol>
</li>
<li><strong>Hardware</strong>:
<ol>
<li>Restore regs (from kernel stack)</li>
<li>Move to user mode</li>
<li>Jump to PC after trap</li>
</ol>
</li>
<li><strong>Program (user mode)</strong>:
<ol>
<li>…</li>
<li>Return from main</li>
<li><strong>trap</strong> (via <code>exit()</code>)</li>
</ol>
</li>
<li><strong>OS</strong>:
<ol>
<li>Free memory of process</li>
<li>Remove from process list</li>
</ol>
</li>
</ol>
<h2 id="Problem-2-Switching-Between-Processes">Problem #2: Switching Between Processes</h2>
<p>Specifically, if a process is running on the CPU, this by definition means the OS is not running. If the OS is not running, how can it do anything at all? In other words: How to regain control of the CPU?</p>
<h3 id="A-Cooperative-Approach-Wait-For-System-Calls">A Cooperative Approach: Wait For System Calls</h3>
<p>In this style, the OS trusts the processes of the system to behave reasonably. Processes that run for too long are assumed to periodically give up the CPU so that the OS can decide to run some other task. Most processes, as it turns out, transfer control of the CPU to the OS quite frequently by making <strong>system calls</strong>, for example, to open a file and subsequently read it, or to send a message to another machine, or to create a new process. Systems like this often include an explicit <strong>yield</strong> system call, which does nothing except to transfer control to the OS so it can run other processes.</p>
<p>Application also transfer control to the OS when they do something illegal. For example, if an application divides by zero, or tries to access memory that it shouldn’t be able to access, it will generate a trap to the OS. The OS will then have control of the CPU again (and likely terminate the offending process).</p>
<h3 id="A-Non-Cooperative-Approach-The-OS-Takes-Control">A Non-Cooperative Approach: The OS Takes Control</h3>
<p>Without some additional help from the hardware, it turns out the OS can’t do much at all when a process refuses to make system calls (or mistakes) and thus return control to the OS. In fact, in the cooperative approach, your only recourse when a process gets stuck in an infinite loop is to resort to the age-old solution to all problems in computer systems: <strong>reboot the machine</strong>. Thus, we again arrive at a subproblem of our general quest to gain control of the CPU.</p>
<p>Solution: <strong>A timer interrupt</strong>. A timer device can be programmed to raise an interrupt every so many milliseconds. When the interrupt is raised, the currently running process is halted, and a pre-configured <strong>interrupt handler</strong> in the OS runs. At this point, the OS has regained control of the CPU, and thus can do what it pleases: stop the current process, and start a different one.</p>
<p>Note that the hardware has some responsibility when an interrupt occurs, in particular to save enough of the state of the program that was running when the interrupt occurred such that a subsequent return-from-trap instruction will be able to resume the running program correctly. This set of actions is quite similar to the behavior of the hardware during an explicit system-call trap into the kernel, with various registers thus getting saved (e.g., onto a kernel stack) and thus easily restored by the return-from-trap instruction.</p>
<h3 id="Saving-and-Restoring-Context">Saving and Restoring Context</h3>
<p>The decision of whether to continue running the currently-running process, or to a different one is made by a part of the operating system known as the <strong>scheduler</strong>.</p>
<p>If the decision is made to switch, the OS then executes a low-level piece of code which we refer to as a <strong>context switch</strong>.</p>
<p>Note that there are 2 types of register saves/restores that happen during this protocol. The first is when the timer interrupt occurs; in this case, the user registers of the running process are implicitly saved by the hardware, using the kernel stack of that process. The second is when the OS decides to switch from A to B; in this case, the kernel registers are explicitly saved by the software (i.e., the OS), but this time into memory in the process structure of the process. The latter action moves the system from running as if it just trapped into the kernel from A to as if it just trapped into the kernel from B.</p>
<p>The following list shows the context switch code for vx6. The <code>context</code> structures <code>old</code> and <code>new</code> are found in the old and new process’s process structures, respectively.</p>
<ol>
<li><strong>OS at boot (kernel mode)</strong>: Initialize trap table</li>
<li><strong>Hardware</strong>: Remember addresses of syscall handler and timer handler</li>
<li><strong>OS at boot (kernel mode)</strong>: Start interrupt timer</li>
<li><strong>Hardware</strong>:
<ol>
<li>Start timer</li>
<li>Interrupt CPU in Xms</li>
<li><strong>timer interrupt!</strong></li>
<li>save regs(A) to k-stack(A)</li>
<li>move to kernel mode</li>
<li>jump to trap handler</li>
</ol>
</li>
<li><strong>OS (kernel mode)</strong>:
<ol>
<li>Handle the trap</li>
<li>Call <code>switch()</code> routine: save regs(A) to proc_t(A), restore regs(B) from proc_t(B), switch to k-stack(B)</li>
<li><strong>return-from-trap</strong></li>
</ol>
</li>
<li><strong>Hardware</strong>:
<ol>
<li>Restore regs(B) from k-stack(B)</li>
<li>Move to user mode</li>
<li>Jump to B’s PC</li>
</ol>
</li>
</ol>
<h2 id="Worried-About-Concurrency">Worried About Concurrency?</h2>
<p>Questions:</p>
<ol>
<li>What happens when , during a system call, a timer interrupt occurs?</li>
<li>What happens when you are handling one interrupt and another one happens?</li>
</ol>
<p>These questions will be handled in <strong>concurrency</strong>.</p>
<p>One simple thing an OS might do is <strong>disable interrupts</strong> during interrupt processing; doing so ensures that when one interrupt is being handled, no other one will be delivered to the CPU.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># void swtch(struct context **old, struct context *new);</span><br><span class="line">#</span><br><span class="line"># Save current reister context in old</span><br><span class="line"># and then load register context from new.</span><br><span class="line">.globl swtch</span><br><span class="line">swtch:</span><br><span class="line">  # Save old registers</span><br><span class="line">  movl 4(%esp), %eax # put old ptr into eax</span><br><span class="line">  popl 0(%eax) # save the old IP</span><br><span class="line">  movl %esp, 4(%eax) # and stack</span><br><span class="line">  movl %ebx, 8(%eax) # and other registers</span><br><span class="line">  movl %ecx, 12(%eax)</span><br><span class="line">  movl %edx, 16(%eax)</span><br><span class="line">  movl %esi, 20(%eax)</span><br><span class="line">  movl %edi, 24(%eax)</span><br><span class="line">  movl %ebp, 28(%eax)</span><br><span class="line">  </span><br><span class="line">  # Load new registers</span><br><span class="line">  movl 4(%esp), %eax # put new ptr into eax</span><br><span class="line">  movl 28(%eax), %ebp # restore other reigsters</span><br><span class="line">  movl 24(%eax), %edi</span><br><span class="line">  movl 20(%eax), %esi</span><br><span class="line">  movl 16(%eax), %edx</span><br><span class="line">  movl 12(%eax), %ecx</span><br><span class="line">  movl 8(%eax), %ebx</span><br><span class="line">  movl 4(%eax), %esp # stack is switched here</span><br><span class="line">  pushl 0(%eax) # return addr put in place</span><br><span class="line">  ret # finally return into new ctxt</span><br></pre></td></tr></table></figure>
<p>Operating systems also have developed a number of sophisticated <strong>locking</strong> schemes to protect concurrent access to internal data structures.</p>
<h2 id="Homework-Measurement">Homework: Measurement</h2>
<ul>
<li>The use of <code>rdtsc</code> and mix of C and assembly language</li>
<li>The use of <code>sched_setaffinity()</code></li>
<li>Measuring the cost of context switch by calling <code>write</code> and <code>read</code> from 2 different processes.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File:    homework_measurement.c</span></span><br><span class="line"><span class="comment">// Author:  C, Tang (u201810307@hust.edu.cn)</span></span><br><span class="line"><span class="comment">// Date:    2020/09/06 01:11:15</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ITER_NUM = <span class="number">1000000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> SCALE = <span class="number">1000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">currentcycles</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title function_">currentcycles</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">// inline function : the inline function will replace all</span></span><br><span class="line"><span class="comment">//                   calls in the assembly language</span></span><br><span class="line">  <span class="type">uint32_t</span> result;</span><br><span class="line">  __asm__ __volatile__ (<span class="string">&quot;rdtsc&quot;</span> : <span class="string">&quot;=A&quot;</span> (result));</span><br><span class="line"> <span class="comment">// __asm__ : start of asm</span></span><br><span class="line"> <span class="comment">// __volatile__ : tell the compiler not to modify my code</span></span><br><span class="line"> <span class="comment">// &quot;rdtsc&quot; : Instruction list. rdtsc gets CPU clock. Stores</span></span><br><span class="line"> <span class="comment">//           lower 32 bits TSC value into eax and higher 32</span></span><br><span class="line"> <span class="comment">//           bits TSC value into edx.</span></span><br><span class="line"> <span class="comment">// &quot;=A&quot; (result) : output operand. &quot;=&quot; means a write-only expression</span></span><br><span class="line"> <span class="comment">//                 &quot;A&quot; (or &quot;a&quot;) is the abbreviation of eax/ex/al.</span></span><br><span class="line"> <span class="comment">//                 (result) is the output C variable.</span></span><br><span class="line"> <span class="comment">// Several output operands could be written: E.g.</span></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> __asm__(</span></span><br><span class="line"><span class="comment">   &quot;movl %%eax, %0\n\t&quot;</span></span><br><span class="line"><span class="comment">   &quot;pushl %%ebx \n\t&quot;</span></span><br><span class="line"><span class="comment">   &quot;popl %1, %2 \n\t&quot;</span></span><br><span class="line"><span class="comment">   &quot;movl %1, %2&quot;</span></span><br><span class="line"><span class="comment">   : &quot;+a&quot;(cr0), &quot;=b&quot;(cr1), &quot;=c&quot;(cr2)</span></span><br><span class="line"><span class="comment"> );</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// here is another example for input operands:</span></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">int main(int __argc, char* __argv[]) &#123;</span></span><br><span class="line"><span class="comment">  int cr0 = 5;</span></span><br><span class="line"><span class="comment">  __asm__ __volatile__(&quot;movl %0, %%cr0&quot;::&quot;a&quot;(cr0));</span></span><br><span class="line"><span class="comment">  return 0;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// with the compiling code: gcc -S example.c</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argv, <span class="type">char</span>* argc[])</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf;</span><br><span class="line">  <span class="type">uint32_t</span> start, end, frequency;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Measuring the CPU frequency</span></span><br><span class="line">  start = currentcycles();</span><br><span class="line">  sleep(<span class="number">1</span>);</span><br><span class="line">  end = currentcycles();</span><br><span class="line">  frequency = end - start;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;cpu MHZ\t:%11f\n&quot;</span>, (<span class="type">double</span>) frequency / <span class="number">1e6</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Measuring the cost of a system call</span></span><br><span class="line">  start = currentcycles();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ITER_NUM; i++) &#123;</span><br><span class="line">    read(STDIN_FILENO, &amp;buf, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  end = currentcycles();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;system call (read 0 byte %d times) total time: %f us, average: %f us\n&quot;</span>, \ </span><br><span class="line">         ITER_NUM, (<span class="type">double</span>) (end-start) / (frequency/<span class="number">1e6</span>), \ </span><br><span class="line">         (<span class="type">double</span>) (end-start) / (frequency/<span class="number">1e6</span>) / ITER_NUM);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Measuring the context switch</span></span><br><span class="line">  <span class="type">int</span> pipefd_1[<span class="number">2</span>], pipefd_2[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> (pipe(pipefd_1) &lt; <span class="number">0</span> or pipe(pipefd_2) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;pipe error!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">pid_t</span> cpid = fork();</span><br><span class="line">  <span class="type">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line">  CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (cpid) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">      perror(<span class="string">&quot;fork failed!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line">      <span class="keyword">switch</span>(sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>)) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">          perror(<span class="string">&quot;sched_setaffinity failed\n&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">          <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ITER_NUM; i++) &#123;</span><br><span class="line">            read(pipefd_1[<span class="number">0</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            write(pipefd_2[<span class="number">0</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      CPU_SET(<span class="number">0</span>, &amp;<span class="built_in">set</span>);</span><br><span class="line">      <span class="keyword">switch</span>(sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>)) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">          perror(<span class="string">&quot;sched_setaffinity failed\n&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">          start = currentcycles();</span><br><span class="line">          <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ITER_NUM; i++) &#123;</span><br><span class="line">            write(pipefd_1[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            read(pipefd_2[<span class="number">0</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          end = currentcycles();</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;context switch (read &amp; write 0 byte %d times) total time: %f us, average: %f us\n&quot;</span>, \ </span><br><span class="line">                 ITER_NUM, (<span class="type">double</span>) (end-start) / (frequency/<span class="number">1e6</span>), \</span><br><span class="line">                 (<span class="type">double</span>) (end-start) / (frequency/<span class="number">1e6</span>) / ITER_NUM);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/images/tardis.png" data-sites="wechat,weibo,qq,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/09/10/Scheduling-The-Multi-Level-Feedback-Queue/" title="Scheduling: The Multi-Level Feedback Queue"><img class="cover" src="/images/dopamine.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Scheduling: The Multi-Level Feedback Queue</div></div></a></div><div class="next-post pull-right"><a href="/2020/08/18/Operating-Systems-Process-API/" title="Operating Systems: Process API"><img class="cover" src="/images/tardis.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Operating Systems: Process API</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Cheng</div><div class="author-info__description">Tech nerd, Amateur programmar, Medical Student</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/tctco"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=859267560&amp;website=www.oicqzone.com" target="_blank" title=""><i class="fab fa-qq"></i></a><a class="social-icon" href="https://github.com/tctco" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:tctco2018@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Mechanism: Limited Direct Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Technique-Limited-Direct-Execution"><span class="toc-number">1.1.</span> <span class="toc-text">Basic Technique: Limited Direct Execution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem-1-Restricted-Operations"><span class="toc-number">1.2.</span> <span class="toc-text">Problem #1: Restricted Operations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem-2-Switching-Between-Processes"><span class="toc-number">1.3.</span> <span class="toc-text">Problem #2: Switching Between Processes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A-Cooperative-Approach-Wait-For-System-Calls"><span class="toc-number">1.3.1.</span> <span class="toc-text">A Cooperative Approach: Wait For System Calls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#A-Non-Cooperative-Approach-The-OS-Takes-Control"><span class="toc-number">1.3.2.</span> <span class="toc-text">A Non-Cooperative Approach: The OS Takes Control</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Saving-and-Restoring-Context"><span class="toc-number">1.3.3.</span> <span class="toc-text">Saving and Restoring Context</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Worried-About-Concurrency"><span class="toc-number">1.4.</span> <span class="toc-text">Worried About Concurrency?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Homework-Measurement"><span class="toc-number">1.5.</span> <span class="toc-text">Homework: Measurement</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/11/29/Nuclear-Medicine-%E7%89%A9%E7%90%86%E5%9F%BA%E7%A1%80%E4%B8%8E%E4%BB%AA%E5%99%A8/" title="Nuclear Medicine 物理基础与仪器"><img src="/images/ink.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nuclear Medicine 物理基础与仪器"/></a><div class="content"><a class="title" href="/2023/11/29/Nuclear-Medicine-%E7%89%A9%E7%90%86%E5%9F%BA%E7%A1%80%E4%B8%8E%E4%BB%AA%E5%99%A8/" title="Nuclear Medicine 物理基础与仪器">Nuclear Medicine 物理基础与仪器</a><time datetime="2023-11-29T12:37:58.000Z" title="发表于 2023-11-29 20:37:58">2023-11-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/23/%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/" title="生存分析笔记"><img src="/images/memory.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="生存分析笔记"/></a><div class="content"><a class="title" href="/2023/11/23/%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/" title="生存分析笔记">生存分析笔记</a><time datetime="2023-11-23T01:31:08.000Z" title="发表于 2023-11-23 09:31:08">2023-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/20/PET%E5%9B%BE%E5%83%8F%E9%87%8D%E5%BB%BA%E5%85%B3%E9%94%AE%E6%80%A7%E5%8F%82%E6%95%B0%E7%AC%94%E8%AE%B0/" title="PET图像重建关键性参数笔记"><img src="/images/piano.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PET图像重建关键性参数笔记"/></a><div class="content"><a class="title" href="/2023/11/20/PET%E5%9B%BE%E5%83%8F%E9%87%8D%E5%BB%BA%E5%85%B3%E9%94%AE%E6%80%A7%E5%8F%82%E6%95%B0%E7%AC%94%E8%AE%B0/" title="PET图像重建关键性参数笔记">PET图像重建关键性参数笔记</a><time datetime="2023-11-20T08:42:45.000Z" title="发表于 2023-11-20 16:42:45">2023-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/19/%E6%A0%91%E8%8E%93%E6%B4%BE4B%E9%85%8D%E7%BD%AEOpenWRT%E8%AE%B0%E5%BD%95/" title="树莓派4B配置OpenWRT记录"><img src="/images/ink.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="树莓派4B配置OpenWRT记录"/></a><div class="content"><a class="title" href="/2023/11/19/%E6%A0%91%E8%8E%93%E6%B4%BE4B%E9%85%8D%E7%BD%AEOpenWRT%E8%AE%B0%E5%BD%95/" title="树莓派4B配置OpenWRT记录">树莓派4B配置OpenWRT记录</a><time datetime="2023-11-19T14:33:47.000Z" title="发表于 2023-11-19 22:33:47">2023-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/10/%E5%BA%B7%E5%A4%8D%E5%8C%BB%E5%AD%A6/" title="无题"><img src="/images/ChristmasTrees.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2023/10/10/%E5%BA%B7%E5%A4%8D%E5%8C%BB%E5%AD%A6/" title="无题">无题</a><time datetime="2023-10-10T04:50:56.442Z" title="发表于 2023-10-10 12:50:56">2023-10-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By Cheng</div><div class="footer_custom_text">很高兴遇见你。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>