<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Scheduling: Proportional Share | TeaPort</title><meta name="author" content="Cheng,tctco2018@gmail.com"><meta name="copyright" content="Cheng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Operating Systems: Three Easy Pieces  We will examine a different type of scheduler known as a proportional-share scheduler, also sometimes referred to as a fair-share scheduler. An early example of">
<meta property="og:type" content="article">
<meta property="og:title" content="Scheduling: Proportional Share">
<meta property="og:url" content="https://tctco.github.io/2020/09/10/Scheduling-Proportional-Share/index.html">
<meta property="og:site_name" content="TeaPort">
<meta property="og:description" content="Operating Systems: Three Easy Pieces  We will examine a different type of scheduler known as a proportional-share scheduler, also sometimes referred to as a fair-share scheduler. An early example of">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tctco.github.io/images/tardis.png">
<meta property="article:published_time" content="2020-09-10T02:06:39.000Z">
<meta property="article:modified_time" content="2025-12-15T10:41:13.420Z">
<meta property="article:author" content="Cheng">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tctco.github.io/images/tardis.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Scheduling: Proportional Share",
  "url": "https://tctco.github.io/2020/09/10/Scheduling-Proportional-Share/",
  "image": "https://tctco.github.io/images/tardis.png",
  "datePublished": "2020-09-10T02:06:39.000Z",
  "dateModified": "2025-12-15T10:41:13.420Z",
  "author": [
    {
      "@type": "Person",
      "name": "Cheng",
      "url": "https://tctco.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/images/favicon.png"><link rel="canonical" href="https://tctco.github.io/2020/09/10/Scheduling-Proportional-Share/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3-b2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Scheduling: Proportional Share',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3878240_kz3gpk6zi4c.css"><link rel="stylesheet" href="/static/css/bilibili.css"><meta name="generator" content="Hexo 8.1.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/static/operations/"><i class="fa-fw iconfont icon-shoushudao1"></i><span> 技能考试</span></a></li><li><a class="site-page child" href="/static/radiations/"><i class="fa-fw iconfont icon-radiation"></i><span> 放射防护考试</span></a></li><li><a class="site-page child" href="/static/model/"><i class="fa-fw iconfont icon-jiandanmoxing"></i><span> 小鼠模型</span></a></li><li><a class="site-page child" href="/static/timetable"><i class="fa-fw iconfont icon--timetable"></i><span> 课表</span></a></li><li><a class="site-page child" href="/static/workingcard"><i class="fa-fw iconfont icon-bangdingyuangongka"></i><span> 员工卡</span></a></li><li><a class="site-page child" href="/static/radar"><i class="fa-fw iconfont icon-radarchart"></i><span> 雷达图</span></a></li><li><a class="site-page child" href="/static/audiogram"><i class="fa-fw iconfont icon-hearing"></i><span> 电测听</span></a></li><li><a class="site-page child" href="/static/medreconstruct"><i class="fa-fw iconfont icon-115"></i><span> 图像重建</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/static/cv"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/images/tardis.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">TeaPort</span></a><a class="nav-page-title" href="/"><span class="site-name">Scheduling: Proportional Share</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/static/operations/"><i class="fa-fw iconfont icon-shoushudao1"></i><span> 技能考试</span></a></li><li><a class="site-page child" href="/static/radiations/"><i class="fa-fw iconfont icon-radiation"></i><span> 放射防护考试</span></a></li><li><a class="site-page child" href="/static/model/"><i class="fa-fw iconfont icon-jiandanmoxing"></i><span> 小鼠模型</span></a></li><li><a class="site-page child" href="/static/timetable"><i class="fa-fw iconfont icon--timetable"></i><span> 课表</span></a></li><li><a class="site-page child" href="/static/workingcard"><i class="fa-fw iconfont icon-bangdingyuangongka"></i><span> 员工卡</span></a></li><li><a class="site-page child" href="/static/radar"><i class="fa-fw iconfont icon-radarchart"></i><span> 雷达图</span></a></li><li><a class="site-page child" href="/static/audiogram"><i class="fa-fw iconfont icon-hearing"></i><span> 电测听</span></a></li><li><a class="site-page child" href="/static/medreconstruct"><i class="fa-fw iconfont icon-115"></i><span> 图像重建</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/static/cv"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Scheduling: Proportional Share</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-10T02:06:39.000Z" title="发表于 2020-09-10 02:06:39">2020-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-15T10:41:13.420Z" title="更新于 2025-12-15 10:41:13">2025-12-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p>Operating Systems: Three Easy Pieces</p>
</blockquote>
<p>We will examine a different type of scheduler known as a <strong>proportional-share</strong> scheduler, also sometimes referred to as a <strong>fair-share</strong> scheduler.</p>
<p>An early example of proportional-share scheduling is known as <strong>lottery scheduling</strong>. The crux is how can we design a scheduler to share the CPU in a proportional manner?</p>
<h2 id="Basic-Concept-Tickets-Represent-Your-Share">Basic Concept: Tickets Represent Your Share</h2>
<p><strong>tickets</strong>: used to represent the share of a resource that a process (or user) should receive.</p>
<p>Lottery allocate resources probabilistically (but not deterministically) by holding a lottery every so often (say, every time slice). The scheduler must know how many total tickets there are. The scheduler then picks a winning ticket. One of the most beautiful aspects of lottery scheduling is its use of <strong>randomness</strong>. When you have to make a decision, using such a randomized approach is often a robust and simple way of doing so.</p>
<ul>
<li>random often avoids strange corner-case behaviors that a more traditional algorithm may have trouble handling.</li>
<li>random also is lightweight, requiring little state to track alternatives.</li>
<li>random can be quite fast</li>
</ul>
<h2 id="Ticket-Mechanisms">Ticket Mechanisms</h2>
<p><strong>ticket currency</strong>: currency allows a user with a set of tickets to allocate tickets among their own jobs in whatever currency they would like; the system then automatically converts said currency into the correct global value.</p>
<p><strong>ticket transfer</strong>: as process can temporarily hand off its tickets to another process. The ability is especially useful in a client/server setting, where a client process sends a message to a server asking it to do some work on the client’s behalf. To speed the work, the client can pass the tickets to the server and thus try to maximize the performance of the server while the server is handling the client’s request. When finished, the server then transfers the tickets back to the client and all is as before.</p>
<p><strong>ticket inflation</strong>: With inflation, a process can temporarily raise or lower the number of tickets it owns. Inflation can be applied in an environment where a group of processes trust one another.</p>
<h2 id="Implementation">Implementation</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// counter: used to track if we&#x27;ve found the winner yet</span></span><br><span class="line"><span class="type">int</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// winner: use some call to a random number generator to</span></span><br><span class="line"><span class="comment">// get a value, between 0 and the total # of tickets</span></span><br><span class="line"><span class="type">int</span> winner = getrandom(<span class="number">0</span>, totaltickets);</span><br><span class="line"><span class="comment">// current: use this to walk through the list of jobs</span></span><br><span class="line"><span class="type">node_t</span> * current = head;</span><br><span class="line"><span class="keyword">while</span> (current) &#123;</span><br><span class="line">  counter = counter + current -&gt; tickets;</span><br><span class="line">  <span class="keyword">if</span> (counter &gt; winner)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  current = current -&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To make this process most efficient, it might generally be best to organize the list in sorted order, from the highest number of tickets to the lowest. The ordering does not affect the correctness of the algorithm; however, it does ensure in general that the fewest number of list iterations are taken, especially if there are a few processes that possess most of the tickets.</p>
<h2 id="Example">Example</h2>
<p><strong>fairness metric</strong>: the time the first job completes divided by the time that the second job completes.</p>
<h2 id="How-to-Assign-Tickets">How to Assign Tickets</h2>
<p>One approach is to assume that the users know best; in such a case, each user is handed some number of tickets, and a user can allocate tickets to any jobs they run as desired. However, this solution is a non-solution: it really does not tell you what to do.</p>
<h2 id="Stride-Scheduling">Stride Scheduling</h2>
<p>Why use randomness at all? It occasionally will not deliver the exact right proportions, especially over short time scales. For this reason, Waldspurger invented <strong>stride scheduling</strong>, a deterministic fair-share scheduler.</p>
<p>Stride scheduling is also straightforward. Each job in the system has a stride, which is inverse in proportion to the number of tickets it has. The strides can be calculated by dividing a large number by the number of tickets each process has been assigned. Every time a process runs, we will increment a counter for it (called its <strong>pass</strong> value) by its stride to track its global progress.</p>
<p>The scheduler then uses the stride and pass to determine which process should run next. The basic idea is simple: at any given time, pick the process to run that has the lowest pass value so far; when you run a process, increment its pass counter by its stride.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curr = remove_min(<span class="built_in">queue</span>); <span class="comment">// pick clinet with min pass</span></span><br><span class="line">schedule(curr); <span class="comment">// run for quantum</span></span><br><span class="line">curr -&gt; pass = curr -&gt; stride; <span class="comment">// update pass using stride</span></span><br><span class="line">insert(<span class="built_in">queue</span>, curr); <span class="comment">// return curr to queue</span></span><br></pre></td></tr></table></figure>
<p>Why use the lottery scheduling at all? No global state! Imagine a new job enters in the middle of our stride scheduling example; what should its pass value be?</p>
<h2 id="The-Linux-Completely-Fair-Scheduler-CFS">The Linux Completely Fair Scheduler (CFS)</h2>
<p>The <strong>Completely Fair Scheduler (CFS)</strong> implements fair-share scheduling, but does so in a highly efficient and scalable manner.</p>
<p>To achieve its efficiency goals, CFS aims to spend very little time making scheduling decisions, through both its inherent design and its clever use of data structures well-suited to the task. Recent studies have shown that scheduler efficiency is surprisingly important. A study shows that even after aggressive optimization, scheduling uses about 5% of overall datacenter CPU time. Reducing that overhead as much as possible is thus a key goal in modern scheduler architecture.</p>
<h3 id="Basic-Operation">Basic Operation</h3>
<p>Whereas most schedulers are based around the concept of a fixed time slice, CFS operates a bit differently. Its goal is simple: to fairly divide a CPU evenly among all competing processes. It does so through a simple counting-based technique known as <strong>virtual runtime (vruntime)</strong>.</p>
<p>As each process runs, it accumulates vruntime. In the most basic case, each process’s vruntime increases at the same rate, in proportion with physical (real) time. When a scheduling decision occurs, CFS will pick the process with the lowest vruntime to run next.</p>
<p>How does the scheduler know when to stop the currently running process, and run the next one? The tension here is clear: if CFS switches too often, fairness is increased, as CFS will ensure that each process receives its share of CPU even over miniscule time windows, but at the cost of performance is increased (reduced context switching), but at the cost of near-term fairness.</p>
<p>CFS manages this tension through various control parameters: <strong>sched_latency</strong>: CFS uses this value to determine how long one process shoudl run before considering a switch (effectively determining its time slice but in a dynamic fashion). A typical sched_latency value is 46 (miliseconds); CFS divides this value by the number (n) of processes running on the CPU to determine the time slice for a process, and thus ensures that over this period of time, CFS will be completely fair.</p>
<p>But what if there are “too many” processes running? Wouldn’t that lead to too small of a time slice, and thus too many context switches? The answer is yes.</p>
<p>To address this issue, CFS adds another parameter, <strong>min_granularity</strong>, which is usually set to a value like 6ms. CFS will never set the time slice of a process to less than this value, ensuring that not too much time is spent in scheduling overhead.</p>
<p>Note that CFS utilizes a periodic timer interrupt, which means it can only make decisions at fixed time intervals. This interrupt goes off frequently (e.g., every 1 ms), giving CFS a chance to wake up and determine if the current job has reached the end of its run. If a job has a time slice that is not a perfect multiple of the timer interrupt interval, that is OK; CFS tracks vruntime precisely, which means that over the long haul, it will eventually approximate ideal sharing of the CPU.</p>
<h3 id="Weighting-Niceness">Weighting (Niceness)</h3>
<p>CFS also enables control over process priority, enabling users or administrators to give some processes a higher share of the CPU. It does this not with tickets, but through a classic UNIX mechanism known as the <strong>nice</strong> level (-20 to +19, lowest) of a process.</p>
<blockquote>
<p>When you are too nice, you just don’t get as much (scheduling) attention, alas.</p>
</blockquote>
<p>CFS maps the nice value of each process to a <code>weight</code>, as shown here:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> prio_to_weight[<span class="number">40</span>] = &#123;</span><br><span class="line">    <span class="comment">/* -20 */</span> <span class="number">88761</span>, <span class="number">71755</span>, <span class="number">56483</span>, <span class="number">46273</span>, <span class="number">36291</span>,</span><br><span class="line">    <span class="comment">/* -15 */</span> <span class="number">29154</span>, <span class="number">23254</span>, <span class="number">18705</span>, <span class="number">14949</span>, <span class="number">11916</span>,</span><br><span class="line">    <span class="comment">/* -10 */</span> <span class="number">9548</span>, <span class="number">7620</span>, <span class="number">6100</span>, <span class="number">4904</span>, <span class="number">3906</span>,</span><br><span class="line">    <span class="comment">/* -5 */</span> <span class="number">3121</span>, <span class="number">2501</span>, <span class="number">1991</span>, <span class="number">1586</span>, <span class="number">1277</span>,</span><br><span class="line">    <span class="comment">/* 0 */</span> <span class="number">1024</span>, <span class="number">820</span>, <span class="number">655</span>, <span class="number">526</span>, <span class="number">423</span>,</span><br><span class="line">    <span class="comment">/* 5 */</span> <span class="number">335</span>, <span class="number">272</span>, <span class="number">215</span>, <span class="number">172</span>, <span class="number">137</span>,</span><br><span class="line">    <span class="comment">/* 10 */</span> <span class="number">110</span>, <span class="number">87</span>, <span class="number">70</span>, <span class="number">56</span>, <span class="number">45</span>,</span><br><span class="line">    <span class="comment">/* 15 */</span> <span class="number">36</span>, <span class="number">29</span>, <span class="number">23</span>, <span class="number">18</span>, <span class="number">15</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>These weights allow us to compute the effective time slice of each process, but now accounting for their priority differences.</p>
<h3 id="Using-Red-Black-Trees">Using Red-Black Trees</h3>
<p>Keep process in a <strong>red-black tree</strong>.</p>
<p>CFS does not keep all process in this structure; rather, only running (or runnable) processes are kept therein. If a process goes to sleep, it is removed from the tree and kept track of elsewhere.</p>
<h3 id="Dealing-With-I-O-And-Sleeping-Processes">Dealing With I/O And Sleeping Processes</h3>
<p>When a process wake up from an I/O, its vruntime will be much shorter than continuous jobs, causing monopoly of the CPU. CFS handles this case by altering the vruntime of a job when it wakes up. Specifically, CFS sets the vruntime of that job to the minimum value found in the tree. In this way, CFS avoids starvation but not without a cost: jobs that sleep for short periods of time frequently do not get their fair share of the CPU.</p>
<h2 id="Homework">Homework</h2>
<ol>
<li>Compute the solutions for simulations with 3 jobs and random seeds of 1, 2, and 3.
<ul>
<li>2 0 1 2 2 2 1 1 1 1 1 1; 2 0 0 2 0 1 0 2 0 0 0 1 0 0 1 2 1 1 1 2 1 1 2; 1 1 0 1 0 2 2 2 2 2 2</li>
</ul>
</li>
<li>Now run with two specific jobs: each of length 10, but one (job 0) with just 1 ticket and the other (job 1) with 100 (e.g., -l 10:1,10:100). What happens when the number of tickets is so imbalanced? Will job 0 ever run before job 1 completes? How often? In general, what does such a ticket imbalance do to the behavior of lottery scheduling?
<ul>
<li>Job 0 will have almost no opportunity to run when job 1 exists. It is still possible for job 0 to run before job 1. Prob: 0.1. Job 1 will run with priority.</li>
</ul>
</li>
<li>When running with two jobs of length 100 and equal ticket allocations of 100 (-l 100:100,100:100), how unfair is the scheduler? Run with some different random seeds to determine the (probabilistic) answer; let unfairness be determined by how much earlier one job finishes than the other.
<ul>
<li>Expected time difference: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mfrac><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>99</mn></msubsup><mo stretchy="false">(</mo><mn>100</mn><mo>−</mo><mi>i</mi><mo stretchy="false">)</mo><msubsup><mi>C</mi><mrow><mn>99</mn><mo>+</mo><mi>i</mi></mrow><mi>i</mi></msubsup></mrow><msubsup><mi>C</mi><mn>200</mn><mn>100</mn></msubsup></mfrac><mo>=</mo><mn>1.98</mn></mrow><annotation encoding="application/x-tex">2\frac{\sum_{i=0}^{99}(100-i)C_{99+i}^i}{C_{200}^{100}} = 1.98</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.775em;vertical-align:-0.5916em;"></span><span class="mord">2</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1833em;"><span style="top:-2.6264em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8051em;"><span style="top:-2.1885em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">200</span></span></span></span><span style="top:-2.8448em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">100</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3115em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5519em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">99</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3214em;"><span></span></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight">100</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9021em;"><span style="top:-2.214em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">99</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3455em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5916em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1.98</span></span></span></span></li>
</ul>
</li>
<li>How does your answer to the previous question change as the quantum size (-q) gets larger?
<ul>
<li>Unfairness should become lower.</li>
</ul>
</li>
<li>Can you make a version of the graph that is found in the chapter? What else would be worth exploring? How would the graph look with a stride scheduler?
<ul>
<li>Seems that I have come up with an equation. However, I am not able to solve it.</li>
</ul>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://tctco.github.io">Cheng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://tctco.github.io/2020/09/10/Scheduling-Proportional-Share/">https://tctco.github.io/2020/09/10/Scheduling-Proportional-Share/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://tctco.github.io" target="_blank">TeaPort</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/images/tardis.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2020/09/11/The-Abstraction-Address-Spaces/" title="The Abstraction: Address Spaces"><img class="cover" src="/images/piano.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">The Abstraction: Address Spaces</div></div><div class="info-2"><div class="info-item-1">The Abstraction: Address Spaces Early Systems From the perspective of memory, early machine didn’t provide much of an abstraction to users. The OS was a set of routines (a library, really) that sat in memory (starting at physical address 0, for example), and there would be one running program (a process) that currently sat in physical memory and used the rest of memory. Multiprogramming and Time Sharing multiprogramming: multiple processes were ready to run at a given time, and the OS would s...</div></div></div></a><a class="pagination-related" href="/2020/09/10/Scheduling-The-Multi-Level-Feedback-Queue/" title="Scheduling: The Multi-Level Feedback Queue"><img class="cover" src="/images/dopamine.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Scheduling: The Multi-Level Feedback Queue</div></div><div class="info-2"><div class="info-item-1">Scheduling: Introduction Workload Assumptions A number of simplifying simplifying assumptions about the process running in the system, sometimes collectively called the workload. We will make the following assumptions about the processes, sometimes called jobs, that are running in the system:  Each job runs for the same amount of time. All jobs arrive at the same time. Once started, each job runs to completion. All jobs only use the CPU. The run-time of each job is known.  Scheduling Metrics ...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/images/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Cheng</div><div class="author-info-description">Tech nerd, Amateur programmar, Medical Student</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/tctco"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=859267560&amp;website=www.oicqzone.com" target="_blank" title=""><i class="fab fa-qq"></i></a><a class="social-icon" href="https://github.com/tctco" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:tctco2018@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Concept-Tickets-Represent-Your-Share"><span class="toc-number">1.</span> <span class="toc-text">Basic Concept: Tickets Represent Your Share</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ticket-Mechanisms"><span class="toc-number">2.</span> <span class="toc-text">Ticket Mechanisms</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">3.</span> <span class="toc-text">Implementation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example"><span class="toc-number">4.</span> <span class="toc-text">Example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-Assign-Tickets"><span class="toc-number">5.</span> <span class="toc-text">How to Assign Tickets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stride-Scheduling"><span class="toc-number">6.</span> <span class="toc-text">Stride Scheduling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Linux-Completely-Fair-Scheduler-CFS"><span class="toc-number">7.</span> <span class="toc-text">The Linux Completely Fair Scheduler (CFS)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Basic-Operation"><span class="toc-number">7.1.</span> <span class="toc-text">Basic Operation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Weighting-Niceness"><span class="toc-number">7.2.</span> <span class="toc-text">Weighting (Niceness)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-Red-Black-Trees"><span class="toc-number">7.3.</span> <span class="toc-text">Using Red-Black Trees</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dealing-With-I-O-And-Sleeping-Processes"><span class="toc-number">7.4.</span> <span class="toc-text">Dealing With I&#x2F;O And Sleeping Processes</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Homework"><span class="toc-number">8.</span> <span class="toc-text">Homework</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/12/14/%E8%A7%A3%E5%86%B3python%E4%B8%ADrequests%E7%AD%89%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/" title="解决python中requests等代理配置问题"><img src="/images/rocket.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="解决python中requests等代理配置问题"/></a><div class="content"><a class="title" href="/2025/12/14/%E8%A7%A3%E5%86%B3python%E4%B8%ADrequests%E7%AD%89%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98/" title="解决python中requests等代理配置问题">解决python中requests等代理配置问题</a><time datetime="2025-12-14T22:56:44.000Z" title="发表于 2025-12-14 22:56:44">2025-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/04/AGENTS/" title="AGENTS"><img src="/images/tardis.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AGENTS"/></a><div class="content"><a class="title" href="/2025/12/04/AGENTS/" title="AGENTS">AGENTS</a><time datetime="2025-12-04T11:58:10.000Z" title="发表于 2025-12-04 11:58:10">2025-12-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/02/SOP/" title="SOP"><img src="/images/CMYK.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SOP"/></a><div class="content"><a class="title" href="/2025/12/02/SOP/" title="SOP">SOP</a><time datetime="2025-12-02T16:37:39.000Z" title="发表于 2025-12-02 16:37:39">2025-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/02/portainer%E6%97%A0%E6%B3%95%E5%88%A9%E7%94%A8%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6%E8%AE%BF%E9%97%AE%E7%9A%84%E9%97%AE%E9%A2%98/" title="portainer无法利用自签名证书访问的问题"><img src="/images/ink.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="portainer无法利用自签名证书访问的问题"/></a><div class="content"><a class="title" href="/2025/12/02/portainer%E6%97%A0%E6%B3%95%E5%88%A9%E7%94%A8%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6%E8%AE%BF%E9%97%AE%E7%9A%84%E9%97%AE%E9%A2%98/" title="portainer无法利用自签名证书访问的问题">portainer无法利用自签名证书访问的问题</a><time datetime="2025-12-02T16:28:35.000Z" title="发表于 2025-12-02 16:28:35">2025-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/28/%E7%94%A8VSCode%E5%86%99cpp%E9%A1%B9%E7%9B%AE/" title="用VSCode写cpp项目"><img src="/images/ChristmasTrees.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用VSCode写cpp项目"/></a><div class="content"><a class="title" href="/2025/11/28/%E7%94%A8VSCode%E5%86%99cpp%E9%A1%B9%E7%9B%AE/" title="用VSCode写cpp项目">用VSCode写cpp项目</a><time datetime="2025-11-28T22:28:21.000Z" title="发表于 2025-11-28 22:28:21">2025-11-28</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2023 - 2025 By Cheng</span></div><div class="footer_custom_text">很高兴遇见你。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3-b2"></script><script src="/js/main.js?v=5.5.3-b2"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>