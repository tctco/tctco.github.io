---
title: 状态机模式
date: 2023-12-20T17:20:18.000Z
tags: null
categories: null
---

状态机模式允许一个类在内部状态发生变化时更改其行为，仿佛它转变为另一个类一样。状态机模式与有限状态机密切相关。

通常的状态机实现随着类所能具有的状态数量增加而显著增加。状态机模式建议将所有所有模式转化为不同的类，并将所有与状态有关的操作封装在这些类当中。

```c++
class AudioPlayer {
  public:
    State* state;
    Song* currentSong;
    int volume;

    AudioPlayer() {
      state = new ReadyState(this);
    }
    ~AudioPlayer() {
      if (state) delete state;
    }
    void changeState(State* s) {
      if (state) delete state;
      state = s;
    }
    void clickLock() {
      state->clickLock();
    }
    void clickPlay() {
      state->clickPlay();
    }
    void clickNext() {
      state->clickNext();
    }
    void clickPrevious() {
      state->clickPrevious();
    }
    void startPlayback() {
      // a service method independent of state
    }
    void stopPlayback() {
      // ...
    }
    void previousSong() {
      // ...
    }
    void fastForward(int time) {
      // ...
    }
    void rewind(int time) {
      // ...
    }
    // more service methods independent of state...
};

class State {
  protected:
    AudioPlayer* player;
  public:
    State(AudioPlayer* p): player(p) {}
    virtual void clickLock() = 0;
    virtual void clickPlay() = 0;
    virtual void clickNext(std::string e) = 0;
    virtual void clickPrevious(std::string e) = 0;
};

class ReadyState: public State {
  void clickLock() override {
    player->changeState(new LockedState(player));
  }
  void clickPlay() override {
    player->changeState(new PlayingState(player));
  }
  void clickNext(std::string e) override {
    player->nextSong();
  }
  void clickPrevious(std::string e) override {
    player->previousSong();
  }
};

class PlayingState: public State {
  void clickLock() override {
    player->changeState(new LockedState(player));
  }
  void clickPlay() override {
    player->changeState(new ReadyState(player));
  }
  void clickNext(std::string e) override {
    if (e == "doubleClick") player->nextSong();
    else player->fastForward(5);
  }
  void clickPrevious(std::string e) {
    if (e == "doubleClick") player->previous();
    else player->rewind(5);
  }
};
```
